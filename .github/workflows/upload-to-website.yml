name: Upload Downloads to Website

# NOTE: IDE warnings about actions resolution are false positives - workflows work correctly on GitHub

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  upload-to-vps:
    name: Upload to pattmsc.online
    runs-on: ubuntu-latest
    env:
      VPS_HOST: pattmsc.online
      VPS_USER: root
      VPS_PORT: 22
      DOWNLOADS_PATH: /var/www/pattmsc.online/public/downloads
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download release assets
        run: |
          # –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–ª–∏–∑
          RELEASE_TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "Latest release: $RELEASE_TAG"
          
          # –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–æ–∫
          mkdir -p downloads
          
          # –°–∫–∞—á–∞—Ç—å –≤—Å–µ assets –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–ª–∏–∑–∞
          curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest \
            | grep "browser_download_url.*\.\(zip\|xpi\|tar\.gz\)" \
            | cut -d : -f 2,3 \
            | tr -d \" \
            | wget -P downloads -i -
          
          echo "üì¶ Downloaded files:"
          ls -lah downloads/
      
      - name: Setup SSH
        continue-on-error: true
        uses: webfactory/ssh-agent@v0.9.1
        with:
          # Secret –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ Settings -> Secrets and variables -> Actions
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY || '' }}
      
      - name: Upload to VPS
        continue-on-error: true
        run: |
          # –î–æ–±–∞–≤–∏—Ç—å VPS –≤ known hosts
          ssh-keyscan -p ${VPS_PORT} $VPS_HOST >> ~/.ssh/known_hosts
          
          # –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É downloads –Ω–∞ VPS –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          ssh -p ${VPS_PORT} $VPS_USER@$VPS_HOST "mkdir -p ${DOWNLOADS_PATH}"
          
          # –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã –Ω–∞ VPS
          rsync -avz --progress \
            -e "ssh -p ${VPS_PORT}" \
            downloads/ \
            $VPS_USER@$VPS_HOST:${DOWNLOADS_PATH}/
          
          echo "‚úÖ Files uploaded to https://$VPS_HOST/downloads/"
      
      - name: Verify upload
        run: |
          echo "üìã Files on server:"
          ssh -p ${VPS_PORT} $VPS_USER@$VPS_HOST "ls -lah ${DOWNLOADS_PATH}/"
          
          echo ""
          echo "‚úÖ Downloads available at:"
          echo "üåê https://$VPS_HOST/downloads/faceit-ai-bot-chrome.zip"
          echo "üåê https://$VPS_HOST/downloads/faceit-ai-bot-firefox.xpi"
          echo "üåê https://$VPS_HOST/downloads/faceit-ai-bot-edge.zip"
          echo "üåê https://$VPS_HOST/downloads/faceit-ai-bot-opera.zip"
          echo "üåê https://$VPS_HOST/downloads/faceit-ai-bot-docker.tar.gz"
