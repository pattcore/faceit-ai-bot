name: Release

on:
  push:
    branches:
      - main
      - release
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/release'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.7
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Get version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
          fi
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build frontend
        run: npm run build

      - name: Build extension
        run: npm run build:extension
      
      - name: Create extension package
        run: |
          mkdir -p dist/releases
          zip -r dist/releases/faceit-ai-bot-extension-${{ steps.version.outputs.version }}.zip extension

      - name: Create web assets package
        run: |
          mkdir -p dist
          tar -czf dist/faceit-ai-bot-web-assets-${{ steps.version.outputs.version }}.tar.gz \
            .next \
            public \
            next.config.* \
            package.json
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/api:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}/api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.web
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/web:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}/web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Create Docker Compose package
        run: |
          mkdir -p dist/docker
          cp docker-compose.yml dist/docker/
          cp .env.example dist/docker/
          cp README.md dist/docker/
          cd dist/docker
          tar -czf ../faceit-ai-bot-docker-${{ steps.version.outputs.version }}.tar.gz *
      
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## üéÆ Faceit Stats Bot ${{ steps.version.outputs.version }}
          
          ### ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å
          
          #### üß© –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
          
          - `faceit-ai-bot-extension-${{ steps.version.outputs.version }}.zip`

          #### üåê –í–µ–±-–∞—Å—Å–µ—Ç—ã

          - `faceit-ai-bot-web-assets-${{ steps.version.outputs.version }}.tar.gz`
          
          #### üê≥ Docker
          
          - **Docker Compose**: `faceit-ai-bot-docker-${{ steps.version.outputs.version }}.tar.gz`
          
          ```bash
          # –°–∫–∞—á–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
          tar -xzf faceit-ai-bot-docker-${{ steps.version.outputs.version }}.tar.gz
          cd faceit-ai-bot
          cp .env.example .env
          # –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env
          docker-compose up -d
          ```
          
          #### üê≥ Docker Images
          
          ```bash
          docker pull ghcr.io/${{ github.repository }}/api:${{ steps.version.outputs.version }}
          docker pull ghcr.io/${{ github.repository }}/web:${{ steps.version.outputs.version }}
          ```
          
          ---
          
          **üåê [–î–µ–º–æ](https://pattmsc.online)** ‚Ä¢ **üìö [API Docs](https://api.pattmsc.online/docs)** ‚Ä¢ **üìñ [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://github.com/pattcore/faceit-ai-bot)**
          
          **–°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è CS2 –∫–æ–º—å—é–Ω–∏—Ç–∏**
          EOF
      
      - name: Create or update release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            dist/releases/*.zip
            dist/releases/*.xpi
            dist/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload to website
        if: success()
        run: |
          # –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
          mkdir -p website-upload/downloads
          
          # –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ä–µ–ª–∏–∑—ã
          cp dist/releases/*.zip website-upload/downloads/ 2>/dev/null || true
          cp dist/releases/*.xpi website-upload/downloads/ 2>/dev/null || true
          cp dist/*.tar.gz website-upload/downloads/ 2>/dev/null || true
          
          # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ (latest)
          if [ -f "dist/releases/faceit-ai-bot-extension-${{ steps.version.outputs.version }}.zip" ]; then
            cp dist/releases/faceit-ai-bot-extension-${{ steps.version.outputs.version }}.zip website-upload/downloads/faceit-ai-bot-extension.zip
          fi
          
          if [ -f "dist/faceit-ai-bot-web-assets-${{ steps.version.outputs.version }}.tar.gz" ]; then
            cp dist/faceit-ai-bot-web-assets-${{ steps.version.outputs.version }}.tar.gz website-upload/downloads/faceit-ai-bot-web-assets.tar.gz
          fi

          if [ -f "dist/faceit-ai-bot-docker-${{ steps.version.outputs.version }}.tar.gz" ]; then
            cp dist/faceit-ai-bot-docker-${{ steps.version.outputs.version }}.tar.gz website-upload/downloads/faceit-ai-bot-docker.tar.gz
          fi
          
          echo "üì¶ Files prepared for upload to pattmsc.online"
          ls -lah website-upload/downloads/
      
      - name: Upload artifacts for website
        uses: actions/upload-artifact@v4
        with:
          name: website-downloads
          path: website-upload/downloads/
          retention-days: 90
      
      - name: Deploy notification
        run: |
          echo "‚úÖ Release ${{ steps.version.outputs.version }} created!"
          echo "üì¶ Docker images pushed to ghcr.io"
          echo "üåê GitHub: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
          echo "‚¨áÔ∏è Downloads ready for pattmsc.online"
